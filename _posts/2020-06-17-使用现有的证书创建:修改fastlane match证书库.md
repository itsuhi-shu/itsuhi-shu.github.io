---
layout: post
title:  "ä½¿ç”¨ç°æœ‰çš„è¯ä¹¦åˆ›å»º/ä¿®æ”¹fastlane matchè¯ä¹¦åº“"
date:   2020-06-17 17:07:44 +0900
categories: ios
---

ä½¿ç”¨fastlaneçš„matchå·¥å…·å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ç®¡ç†iOSé¡¹ç›®çš„è¯ä¹¦å’Œprovisioning profileã€‚  
matchå¯ä»¥å…¨è‡ªåŠ¨åœ°åˆ›å»ºè¯ä¹¦ã€‚ä½†æœ‰äº›æƒ…å†µä¸‹ï¼Œéœ€è¦ä½¿ç”¨å·²æœ‰çš„è¯ä¹¦æ¥ç”Ÿæˆprovisioning profileã€‚  
- æ¯”å¦‚é¡¹ç›®ç»„è§„å®šä¸å¾—æ–°å‘è¡Œdistributionè¯ä¹¦ï¼›
- æ¯”å¦‚ä¸æƒ³å¢åŠ developmentè¯ä¹¦çš„æ•°é‡ï¼ŒåŒæ—¶åˆä¸æƒ³è®©å·²åˆ†å‘çš„adhocåº”ç”¨å¤±æ•ˆè¿™ç§å¾ˆå¾®å¦™çš„ç‰¹æ®Šæƒ…å†µã€‚
- ç­‰ç­‰

~ï¼ˆæ²¡é”™ï¼Œè¯´çš„éƒ½æ˜¯æˆ‘ç°åœ¨æ‰€åœ¨çš„è¿™ä¸ªéº»çƒ¦çš„é¡¹ç›®ç»„...ï¼‰~

ç½‘ä¸Šæœåˆ°äº†ä¸€äº›æ‰‹åŠ¨å°†è¯ä¹¦åŠp12æ–‡ä»¶å¯¼å…¥matchè¯ä¹¦åº“çš„æ–‡ç« ï¼Œä½†å®é™…æ“ä½œä¸‹æ¥ä¼šæŠ¥é”™ã€‚  
ä¸€é¡¿googleåï¼Œç»ˆäºåœ¨fastlaneæ–‡æ¡£çš„è§’è½é‡Œå‘ç°äº†å®˜æ–¹æ”¯æŒçš„æ–¹æ¡ˆï¼Œå°†è¿‡ç¨‹åˆ†äº«å‡ºæ¥ã€‚  

## å®˜æ–¹æ–‡æ¡£

å®˜æ–¹æ–‡æ¡£åœ¨æ­¤ï¼Œè‹±æ–‡å¥½çš„å¤§ä½¬ä»¬ç›´æ¥çœ‹æ–‡æ¡£å°±å¥½äº†ã€‚  
https://docs.fastlane.tools/advanced/other/#manually-manage-the-fastlane-match-repo  

## å®è·µåˆ†äº«

#### 0. ç”¨åŠé€”è€ŒåºŸçš„ä¸ªäººé¡¹ç›®åšå®éªŒ

- ä½¿ç”¨rbenvé™å®šlocalçš„rubyç‰ˆæœ¬
- ä½¿ç”¨bundleræ¥ç®¡ç†gems (fastlane, cocoapods)

![é¡¹ç›®æ–‡ä»¶å¤¹](https://upload-images.jianshu.io/upload_images/1971022-e8633bbfe99d64ea.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 1. è·å–cert id

é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹è±¡è¯ä¹¦çš„cert idï¼Œå¯ä»¥åˆ©ç”¨spaceshipæ¥è·å–ã€‚  
å°†ä¸‹è¿°ä»£ç ä¿å­˜ä¸º`{ä»»æ„æ–‡ä»¶å}.rb`æ–‡ä»¶ï¼Œåœ¨`Spaceship.login()`å¤„æ”¹ä¸ºè‡ªå·±çš„å¼€å‘è€…è´¦å·ã€‚  

```ruby
require 'spaceship'

Spaceship.login('{å¼€å‘è€…è´¦å·your_developer_account@address.com}')
Spaceship.select_team

Spaceship.certificate.all.each do |cert| 
  cert_type = Spaceship::Portal::Certificate::CERTIFICATE_TYPE_IDS[cert.type_display_id].to_s.split("::")[-1]
  puts "Cert id: #{cert.id}, name: #{cert.name}, expires: #{cert.expires}, type: #{cert_type}"
end
```

æ‰“å¼€ç»ˆç«¯æ‰§è¡Œ`ruby {ä»»æ„æ–‡ä»¶å}.rb`ï¼Œç„¶åæ¯”è¾ƒè¯ä¹¦çš„å¤±æ•ˆæ—¶æœŸï¼Œæ‰¾åˆ°æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„è¯ä¹¦çš„cert idã€‚  

![è·å–cert id](https://upload-images.jianshu.io/upload_images/1971022-1859123b98ef1a2a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

#### 2. å¯¼å‡º.cerå’Œ.p12æ–‡ä»¶

ä»keychainä¸­æ‰¾åˆ°å¯¹è±¡è¯ä¹¦ï¼Œå¯¼å‡º.ceråŠ.p12æ–‡ä»¶ã€‚  
**æ³¨æ„.p12æ–‡ä»¶å¯¼å‡ºæ—¶ä¸è¦è®¾ç½®å¯†ç ã€‚matchä¸æ”¯æŒå¯¼å…¥è®¾ç½®è¿‡å¯†ç çš„.p12æ–‡ä»¶ã€‚**  
![å¯¼å‡º.ceråŠ.p12æ–‡ä»¶](https://upload-images.jianshu.io/upload_images/1971022-1dabdcd1741e4f29.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)  
æ–‡ä»¶åè®¾ä¸ºæ­¥éª¤1ä¸­è·å–çš„cert idã€‚  

#### 3. ä¸‹è½½å¹¶è§£å¯†è¯ä¹¦åº“

ç»ˆç«¯cdåˆ°é¡¹ç›®ç›®å½•ä¸‹è¾“å…¥`bundle console`è¿›å…¥bundleæ§åˆ¶å°  

```bash
$ bundle console
irb(main):001:0>
```

æŒ‰ä¸‹è¿°æ‰€ç¤ºï¼Œè®¾ç½®è¯ä¹¦åº“urlï¼Œåˆ†æ”¯branchï¼Œä»¥åŠmatchå¯†ç ã€‚  
matchå¯†ç åœ¨matchä¸‹è½½è¯ä¹¦æ—¶éœ€è¦ç”¨åˆ°ï¼Œmatchä¼šå°†å…¶ä¿å­˜åœ¨keychainä¸­ã€‚  
åœ¨keychainä¸­æœç´¢matchä¼šå‘ç°`match_{è¯ä¹¦åº“url}`çš„å¯†ç é¡¹ï¼Œéœ€è¦æ—¶å‘ç»™é¡¹ç›®ç»„å…¶ä»–æˆå‘˜ã€‚  
ä¸€ä¸ªè¯ä¹¦åº“å¯¹åº”ä¸€ä¸ªmatchå¯†ç   

```
irb(main):001:0> require 'match'
irb(main):002:0> git_url = 'https://github.com/fastlane/example-certificate-repo'
=> "https://github.com/fastlane/example-certificate-repo"
irb(main):003:0> shallow_clone = false
=> false
irb(main):004:0> ENV["MATCH_PASSWORD"] = 'example-password'
=> "example-password"
irb(main):005:0> branch = 'master'
=> "master"
```

ç„¶åä¾æ¬¡æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼Œä¸‹è½½å¹¶è§£å¯†è¯ä¹¦åº“ã€‚  

```
irb(main):006:0> storage = Match::Storage.for_mode("git", { git_url: git_url, shallow_clone: shallow_clone, git_branch: branch, clone_branch_directly: false})
irb(main):007:0> storage.download
irb(main):008:0> encryption = Match::Encryption.for_storage_mode("git", { git_url: git_url, working_directory: storage.working_directory})
irb(main):009:0> encryption.decrypt_files
[14:24:42]: ğŸ”“  Successfully decrypted certificates repo
irb(main):010:0> storage.working_directory
=> "/var/folders/ql/4rgq9x7j51n_971xb332w9lc0000gn/T/d20181105-65220-1oalh6v"
```

æœ«è¡Œçš„ç›®å½•å³æ˜¯ä¸‹è½½åè§£å¯†å¾—åˆ°çš„è¯ä¹¦åº“æœ¬åœ°ç›®å½•  

###### #å…³äºè¯ä¹¦åº“å’Œåˆ†æ”¯

fastlaneæ¨èçš„å®è·µï¼Œæ˜¯å°†ç‹¬è‡ªå»ºç«‹ä¸€ä¸ªç§æœ‰åº“ä½œä¸ºè¯ä¹¦åº“ï¼Œæ¯ä¸ªteamè®¾ä¸€ä¸ªåˆ†æ”¯å­˜æ”¾è¯¥teamçš„è¯ä¹¦åŠprovisioning profileã€‚  
å®é™…æ“ä½œå¯ä»¥æ ¹æ®é¡¹ç›®çš„éœ€æ±‚æ¥è®¾å®šã€‚  

æœ¬äººçš„å®é™…æ“ä½œå¦‚ä¸‹  

```
 ~/dev/RegiQ î‚° î‚  master â— î‚° bundle console
[DEPRECATED] bundle console will be replaced by `bin/console` generated by `bundle gem <name>`
irb(main):001:0> require 'match'
=> true
irb(main):002:0> git_url = 'git@github.com:itsuhi-shu/RegiQ.git'
=> "git@github.com:itsuhi-shu/RegiQ.git"
irb(main):003:0> shallow_clone = false
=> false
irb(main):004:0> ENV["MATCH_PASSWORD"] = '**********************'
=> "**********************"
irb(main):005:0> branch = 'certs'
=> "certs"
irb(main):006:0> storage = Match::Storage.for_mode("git", { git_url: git_url, shallow_clone: shallow_clone, git_branch: branch, clone_branch_directly: false})
=> #<Match::Storage::GitStorage:0x00007f8d4f689758 @git_url="git@github.com:itsuhi-shu/RegiQ.git", @shallow_clone=false, @skip_docs=nil, @branch="certs", @git_full_name=nil, @git_user_email=nil, @clone_branch_directly=false, @git_basic_authorization=nil, @git_bearer_authorization=nil, @type="", @platform="">
irb(main):007:0> storage.download
[16:47:27]: Cloning remote git repo...
[16:47:27]: If cloning the repo takes too long, you can use the `clone_branch_directly` option in match.
[16:47:30]: Checking out branch certs...
=> ["git checkout --orphan certs", "git reset --hard"]
irb(main):008:0> encryption = Match::Encryption.for_storage_mode("git", { git_url: git_url, working_directory: storage.working_directory})
=> #<Match::Encryption::OpenSSL:0x00007f8d4f6c54d8 @keychain_name="git@github.com:itsuhi-shu/RegiQ.git", @working_directory="/var/folders/dj/qqssnmsn6hdgdjjcl98tj98sp6yz76/T/d20200612-9861-zkzbwg">
irb(main):009:0> encryption.decrypt_files
[16:48:19]: ğŸ”“  Successfully decrypted certificates repo
=> []
irb(main):010:0> storage.working_directory
=> "/var/folders/dj/qqssnmsn6hdgdjjcl98tj98sp6yz76/T/d20200612-9861-zkzbwg"
```

ä¸ªäººä¹ æƒ¯ï¼Œç›´æ¥åœ¨ä»£ç åº“ä¸‹å»ºç«‹certsåˆ†æ”¯ä½œä¸ºè¯ä¹¦åº“ï¼Œ  
åœ¨logä¸­çœ‹åˆ°ï¼Œmatchè‡ªåŠ¨ä¸ºæˆ‘åˆ›å»ºäº†certsçš„å­¤å„¿åˆ†æ”¯ï¼Œå°†å…¶ä½œä¸ºæˆ‘çš„è¯ä¹¦åº“ã€‚  

#### 4. æ·»åŠ ç°æœ‰è¯ä¹¦å¹¶ä¸Šä¼ 

`open /var/folders/*********{æ­¥éª¤3ä¸­è¯ä¹¦åº“ç›®å½•}`æ‰“å¼€è¯ä¹¦åº“ç›®å½•ã€‚  
å¦‚æœæ˜¯ç©ºçš„å¯ä»¥æŒ‰matchçš„è§„æ ¼åˆ›å»ºcertsæ–‡ä»¶å¤¹ï¼Œåœ¨å…¶ä¸‹åˆ›å»ºdevelopmentå’Œdistributionæ–‡ä»¶å¤¹åˆ†åˆ«å‚¨å­˜å¼€å‘å’Œå‘å¸ƒç”¨è¯ä¹¦ã€‚  
![å»ºç«‹certsç›®å½•å¹¶æ·»åŠ ç°æœ‰è¯ä¹¦](https://upload-images.jianshu.io/upload_images/1971022-65e97d95e16ac0c9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)  
ç„¶åè¿›è¡Œä¸‹è¿°æ“ä½œåŠ å¯†å¹¶ä¸Šä¼ è¯ä¹¦åº“  

```
irb(main):010:0> encryption.encrypt_files
irb(main):011:0> files_to_commit = Dir[File.join(storage.working_directory, "**", "*.{cer,p12,mobileprovision}")]
irb(main):012:0> storage.save_changes!(files_to_commit: files_to_commit)
```

#### 5. å®Œå·¥

åœ¨é¡¹ç›®çš„fastlaneç›®å½•ä¸‹é…ç½®Matchfileï¼Œå¹¶æ‰§è¡Œmatchæ“ä½œä¹‹åï¼Œfastlaneä¼šä½¿ç”¨ä¸Šä¼ çš„è¯ä¹¦åˆ›å»ºå¹¶ä¸‹è½½provisioning profileã€‚  
![è¯ä¹¦åº“](https://upload-images.jianshu.io/upload_images/1971022-3bca6ad9b29bfc01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)  
æ¥ä¸‹æ¥åªéœ€è¦åœ¨é¡¹ç›®æ–‡ä»¶ä¸­è®¾ç½®provisioning profileä¸ºmatchæ‰“å¤´çš„å³å¯ã€‚å¤§åŠŸå‘Šæˆï¼  

### å‚è€ƒ

http://macoscope.com/blog/simplify-your-life-with-fastlane-match/#migration
https://docs.fastlane.tools/advanced/other/#manually-manage-the-fastlane-match-repo



